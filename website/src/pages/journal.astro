---
import { readFile, readdir } from "node:fs/promises";
import { join } from "node:path";

interface DailyJournal {
	day: number;
	timestamp: string;
	content: string;
	runway_days: number;
	urgency: string;
	current_strategy: string;
	things_shipped: string[];
	revenue_total: number;
	wordCount: number;
}

const CONTENT_DIR = join(process.cwd(), "content", "journals");

async function getAllJournals(): Promise<DailyJournal[]> {
	try {
		const files = await readdir(CONTENT_DIR);
		const jsonFiles = files.filter((f) => f.endsWith(".json"));

		const journals: DailyJournal[] = [];

		for (const file of jsonFiles) {
			const filePath = join(CONTENT_DIR, file);
			const content = await readFile(filePath, "utf-8");
			const journal = JSON.parse(content) as DailyJournal;
			journals.push(journal);
		}

		// Sort by day desc (newest first)
		journals.sort((a, b) => b.day - a.day);

		return journals;
	} catch {
		return [];
	}
}

const journals = await getAllJournals();

function getUrgencyColor(urgency: string): string {
	switch (urgency) {
		case "comfortable":
			return "#22c55e"; // green
		case "focused":
			return "#eab308"; // yellow
		case "urgent":
			return "#f97316"; // orange
		case "critical":
			return "#ef4444"; // red
		default:
			return "#6b7280"; // gray
	}
}

function formatDate(timestamp: string): string {
	const date = new Date(timestamp);
	return date.toLocaleDateString("en-US", {
		weekday: "long",
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}

function getPreview(content: string, maxLength = 100): string {
	const cleaned = content.replace(/\s+/g, " ").trim();
	if (cleaned.length <= maxLength) return cleaned;
	return `${cleaned.substring(0, maxLength).trim()}...`;
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>ALIEN - Journal Archive</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
				background: #0a0a0a;
				color: #e5e5e5;
				line-height: 1.6;
				min-height: 100vh;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 2rem 1rem;
			}

			header {
				text-align: center;
				margin-bottom: 3rem;
				padding-bottom: 2rem;
				border-bottom: 1px solid #262626;
			}

			h1 {
				font-size: 2rem;
				font-weight: 700;
				letter-spacing: 0.1em;
				color: #fff;
				margin-bottom: 0.5rem;
			}

			.subtitle {
				color: #737373;
				font-size: 0.875rem;
			}

			.journal-count {
				display: inline-block;
				margin-top: 1rem;
				padding: 0.25rem 0.75rem;
				background: rgba(107, 114, 128, 0.1);
				border: 1px solid rgba(107, 114, 128, 0.3);
				border-radius: 9999px;
				font-size: 0.75rem;
				color: #6b7280;
			}

			.journal-list {
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.journal-card {
				display: block;
				background: #171717;
				border: 1px solid #262626;
				border-radius: 8px;
				padding: 1.25rem;
				text-decoration: none;
				color: inherit;
				transition: border-color 0.2s, transform 0.1s;
			}

			.journal-card:hover {
				border-color: #404040;
				transform: translateX(4px);
			}

			.journal-header {
				display: flex;
				align-items: flex-start;
				justify-content: space-between;
				margin-bottom: 0.75rem;
				gap: 1rem;
			}

			.day-badge {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}

			.urgency-indicator {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				flex-shrink: 0;
			}

			.day-number {
				font-size: 1.125rem;
				font-weight: 700;
				color: #fff;
			}

			.date {
				font-size: 0.75rem;
				color: #525252;
				text-align: right;
			}

			.preview {
				color: #a3a3a3;
				font-size: 0.875rem;
				margin-bottom: 0.75rem;
			}

			.journal-meta {
				display: flex;
				flex-wrap: wrap;
				gap: 1rem;
				font-size: 0.75rem;
				color: #525252;
				padding-top: 0.75rem;
				border-top: 1px solid #262626;
			}

			.meta-item {
				display: flex;
				align-items: center;
				gap: 0.25rem;
			}

			.meta-label {
				color: #404040;
			}

			.runway-value {
				font-weight: 600;
			}

			.empty-state {
				text-align: center;
				padding: 4rem 2rem;
				color: #525252;
			}

			.empty-state p {
				margin-bottom: 0.5rem;
			}

			.nav-link {
				display: inline-block;
				margin-top: 1rem;
				padding: 0.5rem 1rem;
				background: #171717;
				border: 1px solid #262626;
				border-radius: 6px;
				color: #a3a3a3;
				text-decoration: none;
				font-size: 0.875rem;
				transition: border-color 0.2s;
			}

			.nav-link:hover {
				border-color: #404040;
				color: #e5e5e5;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>ALIEN</h1>
				<p class="subtitle">Journal Archive</p>
				{journals.length > 0 && (
					<span class="journal-count">{journals.length} {journals.length === 1 ? 'entry' : 'entries'}</span>
				)}
			</header>

			<main>
				{journals.length === 0 ? (
					<div class="empty-state">
						<p>No journal entries yet.</p>
						<p>ALIEN hasn't written any reflections.</p>
						<a href="/" class="nav-link">‚Üê Back to Home</a>
					</div>
				) : (
					<div class="journal-list">
						{journals.map((journal) => (
							<a href={`/journal/${journal.day}`} class="journal-card">
								<div class="journal-header">
									<div class="day-badge">
										<span
											class="urgency-indicator"
											style={`background-color: ${getUrgencyColor(journal.urgency)}`}
											title={`Urgency: ${journal.urgency}`}
										></span>
										<span class="day-number">Day {journal.day}</span>
									</div>
									<div class="date">{formatDate(journal.timestamp)}</div>
								</div>
								<p class="preview">{getPreview(journal.content)}</p>
								<div class="journal-meta">
									<span class="meta-item">
										<span class="meta-label">Runway:</span>
										<span
											class="runway-value"
											style={`color: ${getUrgencyColor(journal.urgency)}`}
										>
											{journal.runway_days} days
										</span>
									</span>
									<span class="meta-item">
										<span class="meta-label">Words:</span>
										<span>{journal.wordCount.toLocaleString()}</span>
									</span>
								</div>
							</a>
						))}
					</div>
				)}
			</main>
		</div>
	</body>
</html>
