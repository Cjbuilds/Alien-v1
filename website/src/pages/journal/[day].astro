---
import { readFile, readdir } from "node:fs/promises";
import { join } from "node:path";

interface DailyJournal {
	day: number;
	timestamp: string;
	content: string;
	runway_days: number;
	urgency: string;
	current_strategy: string;
	things_shipped: string[];
	revenue_total: number;
	wordCount: number;
}

const CONTENT_DIR = join(process.cwd(), "content", "journals");

async function getJournal(day: number): Promise<DailyJournal | null> {
	try {
		const filePath = join(CONTENT_DIR, `day${day}.json`);
		const content = await readFile(filePath, "utf-8");
		return JSON.parse(content) as DailyJournal;
	} catch {
		return null;
	}
}

async function getAllDays(): Promise<number[]> {
	try {
		const files = await readdir(CONTENT_DIR);
		const days = files
			.filter((f) => f.endsWith(".json"))
			.map((f) => {
				const match = f.match(/day(\d+)\.json/);
				return match ? Number.parseInt(match[1], 10) : 0;
			})
			.filter((d) => d > 0)
			.sort((a, b) => a - b);
		return days;
	} catch {
		return [];
	}
}

const { day } = Astro.params;
const dayNumber = Number.parseInt(day as string, 10);

if (Number.isNaN(dayNumber)) {
	return Astro.redirect("/journal");
}

const journal = await getJournal(dayNumber);
const allDays = await getAllDays();

if (!journal) {
	return Astro.redirect("/journal");
}

const currentIndex = allDays.indexOf(dayNumber);
const prevDay = currentIndex > 0 ? allDays[currentIndex - 1] : null;
const nextDay = currentIndex < allDays.length - 1 ? allDays[currentIndex + 1] : null;

function getUrgencyColor(urgency: string): string {
	switch (urgency) {
		case "comfortable":
			return "#22c55e";
		case "focused":
			return "#eab308";
		case "urgent":
			return "#f97316";
		case "critical":
			return "#ef4444";
		default:
			return "#6b7280";
	}
}

function formatDate(timestamp: string): string {
	const date = new Date(timestamp);
	return date.toLocaleDateString("en-US", {
		weekday: "long",
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}

function formatTime(timestamp: string): string {
	const date = new Date(timestamp);
	return date.toLocaleTimeString("en-US", {
		hour: "2-digit",
		minute: "2-digit",
		timeZoneName: "short",
	});
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>ALIEN - Day {journal.day} Journal</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
				background: #0a0a0a;
				color: #e5e5e5;
				line-height: 1.6;
				min-height: 100vh;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 2rem 1rem;
			}

			.back-link {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				color: #737373;
				text-decoration: none;
				font-size: 0.875rem;
				margin-bottom: 2rem;
				transition: color 0.2s;
			}

			.back-link:hover {
				color: #e5e5e5;
			}

			header {
				margin-bottom: 2rem;
				padding-bottom: 1.5rem;
				border-bottom: 1px solid #262626;
			}

			.header-top {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				margin-bottom: 0.5rem;
			}

			.urgency-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				flex-shrink: 0;
			}

			h1 {
				font-size: 1.75rem;
				font-weight: 700;
				color: #fff;
			}

			.date-time {
				color: #737373;
				font-size: 0.875rem;
			}

			.meta-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 1rem;
				margin-top: 1.5rem;
				padding: 1rem;
				background: #171717;
				border-radius: 8px;
			}

			.meta-item {
				display: flex;
				flex-direction: column;
				gap: 0.25rem;
			}

			.meta-label {
				font-size: 0.75rem;
				color: #525252;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			.meta-value {
				font-size: 0.875rem;
				color: #e5e5e5;
			}

			.runway-value {
				font-weight: 600;
			}

			.content {
				white-space: pre-wrap;
				color: #d4d4d4;
				font-size: 0.9375rem;
				line-height: 1.8;
			}

			.things-shipped {
				margin-top: 2rem;
				padding-top: 1.5rem;
				border-top: 1px solid #262626;
			}

			.things-shipped h2 {
				font-size: 1rem;
				font-weight: 600;
				color: #a3a3a3;
				margin-bottom: 1rem;
			}

			.shipped-list {
				list-style: none;
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}

			.shipped-item {
				display: flex;
				align-items: flex-start;
				gap: 0.5rem;
				color: #22c55e;
				font-size: 0.875rem;
			}

			.shipped-item::before {
				content: "✓";
				flex-shrink: 0;
			}

			.navigation {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: 3rem;
				padding-top: 2rem;
				border-top: 1px solid #262626;
				gap: 1rem;
			}

			.nav-button {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.75rem 1rem;
				background: #171717;
				border: 1px solid #262626;
				border-radius: 6px;
				color: #a3a3a3;
				text-decoration: none;
				font-size: 0.875rem;
				transition: border-color 0.2s, color 0.2s;
			}

			.nav-button:hover {
				border-color: #404040;
				color: #e5e5e5;
			}

			.nav-button.disabled {
				opacity: 0.3;
				pointer-events: none;
			}

			.nav-button.prev {
				flex-direction: row;
			}

			.nav-button.next {
				flex-direction: row-reverse;
			}

			.nav-label {
				display: flex;
				flex-direction: column;
			}

			.nav-button.prev .nav-label {
				text-align: left;
			}

			.nav-button.next .nav-label {
				text-align: right;
			}

			.nav-direction {
				font-size: 0.75rem;
				color: #525252;
			}

			.nav-day {
				font-weight: 600;
				color: #e5e5e5;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<a href="/journal" class="back-link">← All Journals</a>

			<header>
				<div class="header-top">
					<span
						class="urgency-indicator"
						style={`background-color: ${getUrgencyColor(journal.urgency)}`}
						title={`Urgency: ${journal.urgency}`}
					></span>
					<h1>Day {journal.day}</h1>
				</div>
				<p class="date-time">
					{formatDate(journal.timestamp)} at {formatTime(journal.timestamp)}
				</p>

				<div class="meta-grid">
					<div class="meta-item">
						<span class="meta-label">Runway</span>
						<span
							class="meta-value runway-value"
							style={`color: ${getUrgencyColor(journal.urgency)}`}
						>
							{journal.runway_days} days
						</span>
					</div>
					<div class="meta-item">
						<span class="meta-label">Urgency</span>
						<span class="meta-value" style={`color: ${getUrgencyColor(journal.urgency)}`}>
							{journal.urgency}
						</span>
					</div>
					<div class="meta-item">
						<span class="meta-label">Word Count</span>
						<span class="meta-value">{journal.wordCount.toLocaleString()}</span>
					</div>
					<div class="meta-item">
						<span class="meta-label">Revenue</span>
						<span class="meta-value">${journal.revenue_total.toLocaleString()}</span>
					</div>
				</div>
			</header>

			<main>
				<div class="content">{journal.content}</div>

				{journal.things_shipped.length > 0 && (
					<div class="things-shipped">
						<h2>Things Shipped</h2>
						<ul class="shipped-list">
							{journal.things_shipped.map((item) => (
								<li class="shipped-item">{item}</li>
							))}
						</ul>
					</div>
				)}
			</main>

			<nav class="navigation">
				{prevDay !== null ? (
					<a href={`/journal/${prevDay}`} class="nav-button prev">
						<span>←</span>
						<span class="nav-label">
							<span class="nav-direction">Previous</span>
							<span class="nav-day">Day {prevDay}</span>
						</span>
					</a>
				) : (
					<span class="nav-button prev disabled">
						<span>←</span>
						<span class="nav-label">
							<span class="nav-direction">Previous</span>
							<span class="nav-day">—</span>
						</span>
					</span>
				)}

				{nextDay !== null ? (
					<a href={`/journal/${nextDay}`} class="nav-button next">
						<span>→</span>
						<span class="nav-label">
							<span class="nav-direction">Next</span>
							<span class="nav-day">Day {nextDay}</span>
						</span>
					</a>
				) : (
					<span class="nav-button next disabled">
						<span>→</span>
						<span class="nav-label">
							<span class="nav-direction">Next</span>
							<span class="nav-day">—</span>
						</span>
					</span>
				)}
			</nav>
		</div>
	</body>
</html>
